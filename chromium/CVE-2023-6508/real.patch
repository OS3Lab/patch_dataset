commit a46a75912bb9f31397eeb7f5bc6a99c2f045b3a3
Author: Zakhar Voit <voit@google.com>
Date:   Thu Jan 11 22:29:27 2024 +0000

    [M114-LTS][BreakoutBox] Use KeepAlive to prevent lifetime race with audio delivery
    
    (cherry picked from commit 186dad16ae69183f02730fb26d84e1d53f9f1b04)
    
    Bug: 1497984
    Change-Id: Ic22729b2ef9690203bbb09555d32238959e93a0f
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/5009864
    Commit-Queue: Guido Urdaneta <guidou@chromium.org>
    Cr-Original-Commit-Position: refs/heads/main@{#1221614}
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/5019913
    Reviewed-by: Guido Urdaneta <guidou@chromium.org>
    Cr-Commit-Position: refs/branch-heads/5735@{#1661}
    Cr-Branched-From: 2f562e4ddbaf79a3f3cb338b4d1bd4398d49eb67-refs/heads/main@{#1135570}

diff --git a/third_party/blink/renderer/modules/breakout_box/media_stream_audio_track_underlying_source.cc b/third_party/blink/renderer/modules/breakout_box/media_stream_audio_track_underlying_source.cc
index 7f633af16e7da..fe03412f27ec9 100644
--- a/third_party/blink/renderer/modules/breakout_box/media_stream_audio_track_underlying_source.cc
+++ b/third_party/blink/renderer/modules/breakout_box/media_stream_audio_track_underlying_source.cc
@@ -34,11 +34,12 @@ bool MediaStreamAudioTrackUnderlyingSource::StartFrameDelivery() {
   if (!audio_track)
     return false;
 
-  if (added_to_track_)
+  if (is_connected_to_track_) {
     return true;
+  }
 
   WebMediaStreamAudioSink::AddToAudioTrack(this, WebMediaStreamTrack(track_));
-  added_to_track_ = true;
+  is_connected_to_track_ = this;
   return true;
 }
 
@@ -49,7 +50,7 @@ void MediaStreamAudioTrackUnderlyingSource::DisconnectFromTrack() {
 
   WebMediaStreamAudioSink::RemoveFromAudioTrack(this,
                                                 WebMediaStreamTrack(track_));
-  added_to_track_ = false;
+  is_connected_to_track_.Clear();
   track_.Clear();
 }
 
diff --git a/third_party/blink/renderer/modules/breakout_box/media_stream_audio_track_underlying_source.h b/third_party/blink/renderer/modules/breakout_box/media_stream_audio_track_underlying_source.h
index acce1fbbd5d82..1e06b773fe6e6 100644
--- a/third_party/blink/renderer/modules/breakout_box/media_stream_audio_track_underlying_source.h
+++ b/third_party/blink/renderer/modules/breakout_box/media_stream_audio_track_underlying_source.h
@@ -13,6 +13,7 @@
 #include "third_party/blink/renderer/modules/breakout_box/transferred_frame_queue_underlying_source.h"
 #include "third_party/blink/renderer/modules/modules_export.h"
 #include "third_party/blink/renderer/platform/heap/prefinalizer.h"
+#include "third_party/blink/renderer/platform/heap/self_keep_alive.h"
 
 namespace blink {
 
@@ -64,11 +65,14 @@ class MODULES_EXPORT MediaStreamAudioTrackUnderlyingSource
   const Member<ScriptWrappable> media_stream_track_processor_;
 
   Member<MediaStreamComponent> track_;
-  bool added_to_track_ = false;
 
   media::AudioParameters audio_parameters_;
   scoped_refptr<media::AudioBufferMemoryPool> buffer_pool_;
 
+  // This prevents collection of this object while it is still connected to a
+  // platform MediaStreamTrack.
+  SelfKeepAlive<MediaStreamAudioTrackUnderlyingSource> is_connected_to_track_;
+
   SEQUENCE_CHECKER(sequence_checker_);
 };
 
