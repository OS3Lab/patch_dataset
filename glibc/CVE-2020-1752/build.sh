#!/bin/bash

# ├── glibc
# ├── build_glibc
# └── target_glibc

set -x

# path to build glibc
build_dir="build_glibc"
target_dir="target_glibc"

# clean and create build directory
cd ..
if [ -d "$build_dir" ] ; then
    rm -rf "$build_dir"
    if [ $? -ne 0 ]; then
        echo "Failed to delete $build_dir."
        exit 1
    fi
fi
mkdir $build_dir
if [ $? -ne 0 ]; then
    echo "Failed to create existing $build_dir."
    exit 1
fi

if [ -d "$target_dir" ] ; then
    rm -rf "$target_dir"
    if [ $? -ne 0 ]; then
        echo "Failed to delete existing $target_dir."
        exit 1
    fi
fi
mkdir $target_dir
if [ $? -ne 0 ]; then
    echo "Failed to create $target_dir."
    exit 1
fi


# configure and make
cd $build_dir
../glibc/configure --prefix=`realpath $target_dir`
if [ $? -ne 0 ]; then
    echo "Failed to configure glibc."
    exit 1
else
    make -j`nproc`
    if [ $? -ne 0 ]; then
        echo "Failed to build glibc."
        exit 1
    fi
fi